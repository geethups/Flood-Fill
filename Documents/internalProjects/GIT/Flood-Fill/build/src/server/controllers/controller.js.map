{"version":3,"sources":["controllers/controller.js"],"names":[],"mappings":"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","file":"controllers/controller.js","sourcesContent":["'use strict';\n\nvar Q = require('q'),\n    crypto = require('crypto'),\n    nodemailer = require('nodemailer'),\n    cfgManager = require('../utils/configManager'),\n    mysql = require('mysql'),\n    appCfg = cfgManager.getConfig('app'),\n    dbSchema = cfgManager.getConfig('dbSchema'),\n    queryConstructor = require('../utils/queryConstructor'),\n    getQueryString = queryConstructor.getQueryString,\n    getSelectQueryString = queryConstructor.getSelectQueryString,\n    getSelectLoginQueryString = queryConstructor.getSelectLoginQueryString,\n    getSelectQuesQueryString = queryConstructor.getSelectQuesQueryString,\n    getDeleteQueryString = queryConstructor.getDeleteQueryString,\n    getTable = queryConstructor.getTable;\n\nvar connection;\n\nconnection = mysql.createConnection({\n    host: appCfg.database.host,\n    port: appCfg.database.port,\n    user: appCfg.database.user,\n    password: appCfg.database.password,\n    database: appCfg.database.database\n});\n\nvar _loginHandler = function _loginHandler(req, res, next) {\n    if (req.body) {\n        var query = getSelectLoginQueryString('UserTable', req.body);\n        _queryExecution(query).then(function (response) {\n            if (response.resData.length > 0) {\n                require('crypto').randomBytes(48, function (ex, buf) {\n                    var token = buf.toString('hex');\n                    res.header('access_token', token);\n                    res.send(response);\n                });\n            } else {\n                res.send({\n                    status: 'nok'\n                });\n            }\n        }).catch(function (error) {\n            res.send(error);\n        });\n    } else {\n        res.send('No request body');\n    }\n};\n\nfunction getInsertQuery(tableFile, data, dbOp) {\n    var query,\n        deferred = Q.defer();\n    getTable(tableFile).then(function (table) {\n        query = getQueryString(table, data, dbOp);\n        deferred.resolve(query);\n    }).catch(function (error) {\n        deferred.reject(error);\n    });\n    return deferred.promise;\n}\n\nvar _queryExecution = function _queryExecution(query) {\n    var deferred = Q.defer(),\n        errRes,\n        jsonData;\n    connection.query(query, function (err, resData) {\n        if (err) {\n            errRes = {\n                status: 'nok',\n                message: err\n            };\n            deferred.reject(errRes);\n        } else {\n            jsonData = {\n                status: 'ok',\n                message: 'success',\n                resData: resData\n            };\n            deferred.resolve(jsonData);\n        }\n    });\n    return deferred.promise;\n};\n\nvar _saveDataHandler = function _saveDataHandler(req, res, next) {\n    if (req.body) {\n        var query,\n            tableType,\n            data = req.body;\n        tableType = req.query.tableType;\n        getInsertQuery(tableType, data, 'INSERT').then(function (query) {\n            return query;\n        }).then(function (query) {\n            _queryExecution(query).then(function (resData) {\n                res.send(resData);\n            }).catch(function (error) {\n                res.send(error);\n            });\n        });\n    }\n};\n\nvar _getDataHandler = function _getDataHandler(req, res, next) {\n    if (req.query) {\n        var query, tableType;\n        tableType = req.query.tableType;\n        getTable(tableType).then(function (table) {\n            if (req.query.ques) {\n                query = getSelectQuesQueryString(table, req.query.ques);\n            } else {\n                query = getSelectQuesQueryString(table, 'all');\n            }\n            return query;\n        }).then(function (query) {\n            _queryExecution(query).then(function (resData) {\n                res.send(resData);\n            }).catch(function (error) {\n                res.send(error);\n            });\n        });\n    }\n};\n\nvar _updateHandler = function _updateHandler(req, res, next) {\n    if (req.body) {\n        var query,\n            tableType,\n            data = req.body;\n        tableType = req.query.tableType;\n        getInsertQuery(tableType, data, 'UPDATE').then(function (query) {\n            return query;\n        }).then(function (query) {\n            _queryExecution(query).then(function (resData) {\n                res.send(resData);\n            }).catch(function (error) {\n                res.send(error);\n            });\n        });\n    }\n};\n\nvar _addLikeHandler = function _addLikeHandler(req, res, next) {\n    if (req.body) {\n        var query,\n            data = req.body;\n        query = getSelectQueryString(dbSchema.LikeInfo.tableName, data.queryArr);\n        _queryExecution(query).then(function (response) {\n            if (response.resData.length > 0) {\n                res.send({\n                    status: 'nok'\n                });\n            } else {\n                getInsertQuery('like', data.dataObj, 'INSERT').then(function (query) {\n                    return query;\n                }).then(function (query) {\n                    _queryExecution(query).then(function (response) {\n                        res.send({\n                            status: 'ok'\n                        });\n                    }).catch(function (error) {\n                        res.send(error);\n                    });\n                });\n            }\n        }).catch(function (error) {\n            res.send(error);\n        });\n    }\n};\n\nvar _removeHandler = function _removeHandler(req, res, next) {\n    var query,\n        tableType = req.query.tableType,\n        data = req.query.data;\n    getTable(tableType).then(function (table) {\n        return table;\n    }).then(function (table) {\n        query = getDeleteQueryString(table, data);\n        _queryExecution(query).then(function (response) {\n            if (response && response.resData && response.resData.affectedRows > 0) {\n                res.send({\n                    status: 'ok'\n                });\n            } else {\n                res.send({\n                    status: 'nok'\n                });\n            }\n        }).catch(function (error) {\n            res.send(error);\n        });\n    }).catch(function (error) {\n        log.error('Remove error', error);\n        res.send(error);\n    });\n};\n\nvar _sendEmailHandler = function (req, res, next) {\n    var transporter = nodemailer.createTransport({\n        service: 'Gmail',\n        auth: {\n            user: appCfg.mail.authMail,\n            pass: appCfg.mail.authPass\n        }\n    });\n    var htmlContent = '<div style=\"width: 450px;border: 1px solid #507AAA;height: 250px;text-align: center;' +\n        'font-family: sans-serif;\">' +\n        '<div style=\"width: 450px;height: 35px;background: #507AAA;color: white;padding-top: 14px;font-size: 18px;\">Flood Fill</div>' +\n        '<div><h3 style=\"color:#167016;\">greeting ' + req.body.user + '</h3><h2 style=\"color:#507AAA;\">Welcome to Flood Fill</h2><br/>' +\n        '<p style=\"font-size:16px;\">FloodFill help you to share your thoughts among your colleagues.</p></div></div>';\n    var mailOptions = {\n        from: appCfg.mail.authMail,\n        to: appCfg.mail.mailId + ',' + req.body.toAddr,\n        subject: 'FloodFill',\n        html: htmlContent\n    };\n    transporter.sendMail(mailOptions, function (error, info) {\n        if (error) {\n            console.log(error);\n            res.send({\n                status: 'nok'\n            });\n        } else {\n            console.log('Message sent: ' + info.response);\n            res.send({\n                status: 'ok',\n                data: info.response\n            });\n        };\n    });\n};\n\nvar controller = {\n    _login: _loginHandler,\n    _save: _saveDataHandler,\n    _update: _updateHandler,\n    _get: _getDataHandler,\n    _addLike: _addLikeHandler,\n    _remove: _removeHandler,\n    _addUser: _saveDataHandler,\n    _sendEmail: _sendEmailHandler\n};\n\nmodule.exports = controller;\n//# sourceMappingURL=controller.js.map\n"],"sourceRoot":"/home/geethu/Documents/internalProjects/openshift/floodfill/es6"}